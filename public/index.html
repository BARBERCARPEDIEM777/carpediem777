<script>
    // --- ESTADO DE LA APLICACIÓN ---
    let ADMIN_PASSWORD = 'admin123';
    let services = [];
    let barbers = [];
    let sales = []; // Almacena las ventas del día cargadas desde el servidor

    // --- FUNCIONES DE UTILIDAD ---
    const currencyFormatter = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    function formatCOP(value) { return currencyFormatter.format(value); }

    // --- LÓGICA DE LOGIN Y NAVEGACIÓN ---
    async function login() {
        const role = document.getElementById('role-select').value;
        if (role === 'admin' && document.getElementById('admin-password').value !== ADMIN_PASSWORD) {
            alert('Contraseña incorrecta.');
            return;
        }
        await loadInitialData();
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        const isAdmin = (role === 'admin');
        document.querySelectorAll('.admin-only').forEach(el => { el.style.display = isAdmin ? 'block' : 'none'; });
        document.querySelector('.grid-container').style.gridTemplateColumns = isAdmin ? '1fr 1fr' : '1fr';
        document.getElementById('filter-date').value = new Date().toISOString().slice(0, 10);
        await renderAll();
    }

    async function loadInitialData() {
        try {
            const response = await fetch('/api/data');
            if (!response.ok) throw new Error('Error de red al cargar datos.');
            const data = await response.json();
            services = data.services || [];
            barbers = data.barbers || [];
        } catch (error) {
            console.error('Error cargando datos:', error);
            alert('No se pudieron cargar los datos del servidor.');
        }
    }

    // --- GESTIÓN DE SERVICIOS (CONECTADO AL BACKEND) ---
    async function addService() {
        const nameInput = document.getElementById('service-name');
        const priceInput = document.getElementById('service-price');
        if (!nameInput.value.trim() || !priceInput.value) { alert('Por favor, ingresa un nombre y precio válidos.'); return; }
        try {
            await fetch('/api/services', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: nameInput.value.trim(), price: parseFloat(priceInput.value) }) });
            await loadInitialData();
            renderAll();
            nameInput.value = '';
            priceInput.value = '';
        } catch (error) { alert('Error al guardar el servicio.'); }
    }
    async function deleteService(id) {
        if (confirm('¿Estás seguro?')) {
            try {
                await fetch(`/api/services/${id}`, { method: 'DELETE' });
                await loadInitialData();
                renderAll();
            } catch (error) { alert('Error al eliminar el servicio.'); }
        }
    }

    // --- GESTIÓN DE BARBEROS (CONECTADO AL BACKEND) ---
    async function addBarber() {
        const nameInput = document.getElementById('barber-name');
        const commissionInput = document.getElementById('barber-commission');
        if (!nameInput.value.trim() || !commissionInput.value) { alert('Ingresa un nombre y comisión válida (0-100).'); return; }
        try {
            await fetch('/api/barbers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: nameInput.value.trim(), commission: parseFloat(commissionInput.value) }) });
            await loadInitialData();
            renderAll();
            nameInput.value = '';
            commissionInput.value = '';
        } catch (error) { alert('Error al guardar el barbero.'); }
    }
    async function deleteBarber(id) {
        if (confirm('¿Estás seguro?')) {
            try {
                await fetch(`/api/barbers/${id}`, { method: 'DELETE' });
                await loadInitialData();
                renderAll();
            } catch (error) { alert('Error al eliminar el barbero.'); }
        }
    }

    // --- GESTIÓN DE VENTAS (CONECTADO AL BACKEND) ---
    async function addSale() {
        const barberId = Number(document.getElementById('sale-barber-select').value);
        const barber = barbers.find(b => b.id === barberId);
        if (!barber) { alert('Por favor, selecciona un barbero.'); return; }
        const selectedServices = Array.from(document.querySelectorAll('#sale-services-list input:checked')).map(cb => services.find(s => s.id === Number(cb.value))).filter(Boolean);
        if (selectedServices.length === 0) { alert('Debes seleccionar al menos un servicio.'); return; }
        const paymentMethod = document.getElementById('payment-method-select').value;
        const totalPrice = selectedServices.reduce((sum, s) => sum + s.price, 0);
        const newSale = { barber, services: selectedServices, totalPrice, paymentMethod };
        try {
            const response = await fetch('/api/sales', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newSale) });
            if (!response.ok) throw new Error('Error del servidor al guardar la venta.');
            await loadSalesForToday();
            document.querySelectorAll('#sale-services-list input:checked').forEach(cb => cb.checked = false);
        } catch (error) { console.error(error); alert('Hubo un error al guardar la venta.'); }
    }

    async function loadSalesForToday() {
        const dateString = document.getElementById('filter-date').value;
        try {
            const response = await fetch(`/api/sales?date=${dateString}`);
            if (!response.ok) throw new Error('No se pudieron cargar las ventas.');
            sales = await response.json(); // Guardar los datos crudos del servidor
            renderFilteredSales();
        } catch (error) {
            console.error(error);
            sales = [];
            renderFilteredSales();
        }
    }

    // --- RENDERIZADO DE LA INTERFAZ ---
    async function renderAll() {
        renderServicesTable();
        renderBarbersTable();
        renderServiceSelection();
        renderBarberSelection();
        await loadSalesForToday();
    }
    
    // =================================================================
    // FUNCIÓN CORREGIDA
    // =================================================================
    function renderFilteredSales() {
        const tbody = document.querySelector('#sales-table tbody');
        let dailyTotal = 0, commissionTotal = 0;
        tbody.innerHTML = '';
        
        if (!sales || sales.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No hay ventas para esta fecha.</td></tr>';
        } else {
            sales.forEach(sale => {
                // CORRECCIÓN: Buscar el objeto 'barber' completo en nuestra lista local de barberos.
                const barberInfo = barbers.find(b => b.name === sale.barber_name);
